# -*- mode: makefile; coding: utf-8 -*-
# Copyright © 2003 Colin Walters <walters@debian.org>
# Copyright © 2006 Marc Dequènes (Duck) <Duck@DuckCorp.org>
# Copyright © 2003,2006-2010 Jonas Smedegaard <dr@jones.dk>
# Description: manage Python modules using the 'distutils' build system
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation; either version 2, or (at
# your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

#PATH_RULES#

ifndef _cdbs_class_python3_distutils
_cdbs_class_python3_distutils = 1

include $(_cdbs_class_path)/python3-module.mk$(_cdbs_makefile_suffix)

DEB_PYTHON3_SETUP_CMD ?= setup.py
DEB_PYTHON3_CLEAN_ARGS ?= -a
DEB_PYTHON3_BUILD_ARGS_ALL ?= --build-base="$(CURDIR)/$(DEB_BUILDDIR)/build"
DEB_PYTHON3_BUILD_ARGS ?= --executable=/usr/bin/python3
DEB_PYTHON3_INSTALL_ARGS_ALL ?= --install-layout=deb
#DEB_PYTHON3_INSTALL_ARGS

# Python-related dependencies according to Python policy, appendix A
CDBS_BUILD_DEPENDS_class_python3-distutils ?= $(if $(cdbs_python3_arch_packages),python3-all-dev,python3-dev $(cdbs_python3_nondefault_version:%=, python%-dev))
CDBS_BUILD_DEPENDS += , $(CDBS_BUILD_DEPENDS_class_python3-distutils)


pre-build::
	mkdir -p debian/python3-module-stampdir

$(patsubst %,build/%,$(cdbs_python3_indep_packages) $(cdbs_python3_arch_packages)) :: build/% : debian/python3-module-stampdir/%

# build stage
$(patsubst %,debian/python3-module-stampdir/%,$(cdbs_python3_indep_packages)) :: debian/python3-module-stampdir/%:
	cd $(DEB_SRCDIR) && python$(cdbs_python3_nondefault_version) $(DEB_PYTHON3_SETUP_CMD) build $(DEB_PYTHON3_BUILD_ARGS_ALL)
	touch $@

$(patsubst %,debian/python3-module-stampdir/%,$(cdbs_python3_arch_packages)) :: debian/python3-module-stampdir/%:
	set -e; for buildver in $(cdbs_python3_build_versions); do \
		cd $(CURDIR) && cd $(DEB_SRCDIR) && \
		python$$buildver $(DEB_PYTHON3_SETUP_CMD) build $(DEB_PYTHON3_BUILD_ARGS_ALL) $(DEB_PYTHON3_BUILD_ARGS); \
	done
	touch $@


# install stage
$(patsubst %,install/%,$(cdbs_python3_indep_packages)) :: install/%:
	cd $(DEB_SRCDIR) && \
	python$(cdbs_python3_nondefault_version) $(DEB_PYTHON3_SETUP_CMD) install --root=$(cdbs_python3_destdir) $(DEB_PYTHON3_INSTALL_ARGS_ALL)

$(patsubst %,install/%,$(cdbs_python3_arch_packages)) :: install/%:
	set -e; for buildver in $(cdbs_python3_build_versions); do \
		cd $(CURDIR) && cd $(DEB_SRCDIR) && \
		python$$buildver $(DEB_PYTHON3_SETUP_CMD) install --root=$(cdbs_python3_destdir) $(DEB_PYTHON3_INSTALL_ARGS_ALL) $(DEB_PYTHON3_INSTALL_ARGS); \
	done

# clean stage
clean:: $(patsubst %,python3-module-clean/%,$(cdbs_python3_indep_packages) $(cdbs_python3_arch_packages))

$(patsubst %,python3-module-clean/%,$(cdbs_python3_indep_packages)) :: python3-module-clean/%:
	-cd $(DEB_SRCDIR) && python$(cdbs_python3_nondefault_version) $(DEB_PYTHON3_SETUP_CMD) clean $(DEB_PYTHON3_CLEAN_ARGS)

$(patsubst %,python3-module-clean/%,$(cdbs_python3_arch_packages)) :: python3-module-clean/%:
	-for buildver in $(cdbs_python3_build_versions); do \
		cd $(CURDIR) && cd $(DEB_SRCDIR) && \
		python$$buildver $(DEB_PYTHON3_SETUP_CMD) clean $(DEB_PYTHON3_CLEAN_ARGS); \
	done

# cleanup stamp dir
# (dh_clean choke on dirs named stamp, so need to happen before clean::)
clean:: clean-python3-distutils
clean-python3-distutils::
	rm -rf debian/python3-module-stampdir

# Calling setup.py clean may create .pyc files and __pycache__ direcotries, so
# we need a final cleanup pass here.
# Also clean up .egg-info files generated by setuptools
clean::
	find $(CURDIR) -name '*.py[co]' -delete
	find $(CURDIR) -name __pycache__ -type d -empty -delete
	find $(CURDIR) -prune -name '*.egg-info' -exec rm -rf '{}' ';'

.PHONY: $(patsubst %,debian/python3-module-stampdir/%,$(cdbs_python3_indep_packages) $(cdbs_python3_arch_packages))
.PHONY: $(patsubst %,python3-module-clean/%,$(cdbs_python3_indep_packages) $(cdbs_python3_arch_packages))
endif
