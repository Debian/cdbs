# -*- mode: makefile; coding: utf-8 -*-
# Copyright © 2010 IOhannes m zmölnig <zmoelnig@iem.at>
# Description: packaging routines for puredata
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation; either version 2, or (at
# your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

####
# this snippet will take care of properly handling the uncommon suffix of
# pd-externals (.pd_linux for dlopen()ed plugins), which otherwise are not
# handled by shlibdeps/strip
#
# TODO
#   automatic handling of LICENSE.txt
#   ...
####

#PATH_RULES#

ifndef _cdbs_class_pd
_cdbs_class_pd := 1

include $(_cdbs_class_path)/langcore.mk$(_cdbs_makefile_suffix)
include $(_cdbs_rules_path)/buildcore.mk$(_cdbs_makefile_suffix)

cdbs_pd_nostrip_package =
ifneq (,$(filter nostrip,$(DEB_BUILD_OPTIONS)))
 cdbs_pd_nostrip_package = yes
endif

# pd externals have the uncommon extension .pd_linux, which prevents them from
# being properly detected by dh_shlibdeps, so we do it manually
$(patsubst %,binary-predeb-IMPL/%,$(DEB_ALL_PACKAGES)) ::
	dpkg-shlibdeps $(shell find $(cdbs_curdestdir) -name "*.pd_linux") -Tdebian/$(cdbs_curpkg).substvars
$(patsubst %,binary-strip-IMPL/%,$(DEB_ALL_PACKAGES)) ::
	$(if $(cdbs_pd_nostrip_package),,strip --remove-section=.comment --remove-section=.note --strip-unneeded $(shell find $(cdbs_curdestdir) -name "*.pd_linux"))

#endif _cdbs_class_pd
endif
